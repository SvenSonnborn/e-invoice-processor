generator client {
  provider = "prisma-client"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

enum InvoiceFormat {
  ZUGFERD
  XRECHNUNG
  UNKNOWN
}

enum InvoiceStatus {
  CREATED    // Invoice-Datensatz existiert, noch nicht verarbeitet
  PARSED     // Rohdaten erfolgreich extrahiert
  VALIDATED  // Fachlich validiert (Summen, Pflichtfelder)
  EXPORTED   // Mindestens ein Export erfolgreich erstellt
  FAILED     // Verarbeitung fehlgeschlagen
}

enum GoBDComplianceStatus {
  COMPLIANT
  NON_COMPLIANT
  WARNING
}

enum UploadStatus {
  PENDING
  PROCESSED
  FAILED
}

enum ExportFormat {
  CSV
  DATEV
}

enum ExportStatus {
  CREATED     // Export-Datensatz erstellt, noch nicht generiert
  GENERATING  // Export wird gerade generiert
  READY       // Export erfolgreich erstellt
  FAILED      // Generierung fehlgeschlagen
}

enum MemberRole {
  OWNER
  ADMIN
  MEMBER
}

enum SubscriptionStatus {
  INCOMPLETE
  INCOMPLETE_EXPIRED
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  UNPAID
  PAUSED
}

enum SubscriptionTier {
  FREE
  BASIC
  PRO
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members  OrganizationMember[]
  invoices Invoice[]
  exports  Export[]
  uploads  Upload[]

  @@index([name])
}

model User {
  id             String   @id @default(cuid())
  email          String   @unique
  name           String?
  supabaseUserId String?  @unique @db.Uuid
  subscriptionTier SubscriptionTier @default(FREE)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  memberships     OrganizationMember[]
  createdInvoices Invoice[]            // Invoices created by this user
  createdExports  Export[]             // Exports created by this user
  subscriptions   Subscription[]       // User's subscriptions
  payments        Payment[]            // User's payment history

  @@index([supabaseUserId])
  @@index([subscriptionTier])
}

model OrganizationMember {
  id             String     @id @default(cuid())
  userId         String
  organizationId String
  role           MemberRole @default(MEMBER)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
}

model Upload {
  id             String       @id @default(cuid())
  organizationId String?
  filename       String
  contentType    String?
  sizeBytes      Int?
  storageKey     String
  status         UploadStatus @default(PENDING)
  errorMessage   String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  invoice      Invoice?

  @@index([organizationId])
  @@index([status])
}

model Invoice {
  id             String        @id @default(cuid())
  organizationId String?
  uploadId       String?       @unique
  createdBy      String?       // FK to User (who created this invoice)

  // Invoice data
  format         InvoiceFormat @default(UNKNOWN)
  number         String?
  supplierName   String?
  customerName   String?
  issueDate      DateTime?
  dueDate        DateTime?
  currency       String?       @default("EUR")
  netAmount      Decimal?      @db.Decimal(18, 2)
  taxAmount      Decimal?      @db.Decimal(18, 2)
  grossAmount    Decimal?      @db.Decimal(18, 2)

  rawJson        Json?

  // Processing tracking
  status            InvoiceStatus @default(CREATED)
  lastProcessedAt   DateTime?
  processingVersion Int           @default(1)

  // GoBD compliance tracking
  gobdStatus        GoBDComplianceStatus?
  gobdViolations    Json?
  gobdValidatedAt   DateTime?

  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  organization Organization?     @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  upload       Upload?            @relation(fields: [uploadId], references: [id], onDelete: SetNull)
  creator      User?              @relation(fields: [createdBy], references: [id], onDelete: SetNull)
  exports      ExportInvoice[]
  revisions    InvoiceRevision[]  // Revision history
  lineItems    InvoiceLineItem[]  // Invoice line items (positions)

  @@index([organizationId])
  @@index([format])
  @@index([issueDate])
  @@index([status])
  @@index([createdBy])
}

model InvoiceRevision {
  id               String   @id @default(cuid())
  invoiceId        String
  rawJson          Json
  processorVersion String
  createdAt        DateTime @default(now())

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([createdAt])
  @@index([processorVersion])
}

model InvoiceLineItem {
  id            String   @id @default(cuid())
  invoiceId     String
  positionIndex Int      // Reihenfolge der Position (1, 2, 3, ...)
  description   String?  @db.Text
  quantity      Decimal? @db.Decimal(18, 4)
  unitPrice     Decimal? @db.Decimal(18, 4)
  taxRate       Decimal? @db.Decimal(5, 2) // z.B. 19.00 f√ºr 19%
  netAmount     Decimal? @db.Decimal(18, 2)
  taxAmount     Decimal? @db.Decimal(18, 2)
  grossAmount   Decimal? @db.Decimal(18, 2)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@unique([invoiceId, positionIndex]) // Keine doppelten Positionen
  @@index([invoiceId])
  @@index([positionIndex])
}

model Export {
  id             String       @id @default(cuid())
  organizationId String?
  createdBy      String?      // FK to User (who created this export)
  format         ExportFormat
  filename       String
  storageKey     String?

  // Export status tracking
  status       ExportStatus @default(CREATED)
  errorMessage String?      @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization?  @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  creator      User?          @relation(fields: [createdBy], references: [id], onDelete: SetNull)
  invoices     ExportInvoice[]

  @@index([organizationId])
  @@index([format])
  @@index([status])
  @@index([createdBy])
}

model ExportInvoice {
  exportId  String
  invoiceId String

  export  Export  @relation(fields: [exportId], references: [id], onDelete: Cascade)
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@id([exportId, invoiceId])
  @@index([invoiceId])
}

model Subscription {
  id                   String             @id @default(cuid())
  userId               String
  stripeCustomerId     String             @unique
  stripeSubscriptionId String?            @unique
  stripePriceId        String?
  status               SubscriptionStatus @default(INCOMPLETE)
  tier                 SubscriptionTier   @default(FREE)
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  trialStart           DateTime?
  trialEnd             DateTime?
  canceledAt           DateTime?
  cancelAtPeriodEnd    Boolean            @default(false)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@index([status])
  @@index([tier])
}

model Payment {
  id                String    @id @default(cuid())
  userId            String
  stripePaymentId   String?   @unique
  stripeInvoiceId   String?
  amount            Decimal   @db.Decimal(18, 2)
  currency          String    @default("EUR")
  status            String    // succeeded, failed, pending
  description       String?
  receiptUrl        String?
  paidAt            DateTime?
  createdAt         DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([stripePaymentId])
  @@index([status])
  @@index([createdAt])
}

