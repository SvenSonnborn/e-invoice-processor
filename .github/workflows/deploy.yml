name: Deploy

on:
  workflow_run:
    workflows: [CI]
    types: [completed]
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'push' }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
      - uses: actions/download-artifact@v4
        with:
          name: next-build
          path: next-build
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Move artifact to .next directory
        run: |
          if [ -d "next-build" ]; then
            mv next-build .next
            echo "Build artifact moved to .next directory"
          else
            echo "Error: next-build directory not found after download"
            exit 1
          fi
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - name: Generate Prisma Client
        run: DATABASE_URL="postgresql://dummy:dummy@localhost:5432/dummy" bun run db:generate
        env:
          DATABASE_URL: "postgresql://dummy:dummy@localhost:5432/dummy"
      # TODO: Add deployment steps based on your hosting provider
      # - name: Deploy to production
      #   run: echo "Deploy to production"
