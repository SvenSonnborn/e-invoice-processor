name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  # Dummy values for Prisma generate (doesn't need real DB connection)
  DATABASE_URL: "postgresql://dummy:dummy@localhost:5432/dummy"
  DIRECT_URL: "postgresql://dummy:dummy@localhost:5432/dummy"

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.3.6
      - name: Install dependencies
        run: bun install
      - name: Run linter
        run: bun run lint

  type-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.3.6
      - name: Install dependencies
        run: bun install
      - name: Type check
        run: bunx tsc --noEmit

  test:
    runs-on: ubuntu-latest
    env:
      NODE_ENV: test
      GOOGLE_CLOUD_VISION_API_KEY: "dummy-api-key"
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.3.6
      - name: Install dependencies
        run: bun install
      - name: Run tests
        run: bun test
        # TODO: Add test command when tests are implemented

  build:
    runs-on: ubuntu-latest
    environment: production
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      DIRECT_URL: ${{ secrets.DIRECT_URL }}
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      NEXT_PUBLIC_SITE_URL: ${{ secrets.NEXT_PUBLIC_SITE_URL }}
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.3.6
      - name: Install dependencies
        run: bun install
      - name: Build
        run: bun run build
        env:
          NEXT_PUBLIC_SUPABASE_URL: "https://dummy.supabase.co"
          NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY: "dummy-key"
          SUPABASE_SERVICE_ROLE_KEY: "dummy-service-role-key"
          NEXT_PUBLIC_SITE_URL: "http://localhost:3000"
      - name: Debug build output
        run: |
          echo "Current directory:"
          pwd
          echo ""
          echo "Listing all files and directories:"
          ls -la
          echo ""
          echo "Checking for .next directory:"
          if [ -d ".next" ]; then
            echo "✓ .next directory exists"
            ls -la .next
          else
            echo "✗ .next directory NOT found"
          fi
          echo ""
          echo "Checking for out directory:"
          if [ -d "out" ]; then
            echo "✓ out directory exists"
          else
            echo "✗ out directory NOT found"
          fi
      - name: Verify build output
        run: |
          if [ ! -d ".next" ]; then
            echo "Error: .next directory not found after build. The build may have failed."
            exit 1
          fi
          echo "Build output verified: .next directory exists"
      - name: List .next contents before upload
        run: |
          find .next -type f | head -10
          echo "Total files in .next:"
          find .next -type f | wc -l
      - name: Copy .next to next-build for artifact upload
        run: |
          cp -r .next next-build
          ls -la next-build | head -10
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: next-build
          path: next-build
          if-no-files-found: error
